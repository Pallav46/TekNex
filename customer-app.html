<!DOCTYPE html>
<html>
<head>
    <title>Customer Portal - CRM</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; }
        .container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 500px; width: 90%; overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .content { padding: 30px; }
        .screen { display: none; }
        .screen.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #f5f5f5; color: #333; margin-top: 10px; }
        .btn-secondary:hover { background: #e0e0e0; }
        .chat-box { border: 2px solid #e0e0e0; border-radius: 12px; height: 400px; display: flex; flex-direction: column; background: #f9f9f9; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; }
        .message { margin-bottom: 15px; animation: slideIn 0.3s; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.bot { text-align: left; }
        .message.customer { text-align: right; }
        .message.sales { text-align: left; }
        .message-bubble { display: inline-block; padding: 12px 18px; border-radius: 18px; max-width: 80%; word-wrap: break-word; }
        .message.bot .message-bubble { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-bottom-left-radius: 4px; }
        .message.customer .message-bubble { background: #dcf8c6; color: #000; border-bottom-right-radius: 4px; }
        .message.sales .message-bubble { background: #e3f2fd; color: #000; border-bottom-left-radius: 4px; }
        .message-sender { font-size: 11px; opacity: 0.7; margin-bottom: 4px; font-weight: 600; }
        .chat-input-area { padding: 15px; background: white; border-top: 2px solid #e0e0e0; display: flex; gap: 10px; }
        .chat-input-area input { flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 20px; font-size: 14px; }
        .chat-input-area button { padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: 600; }
        .bot-options { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .bot-option { padding: 12px; background: white; border: 2px solid #667eea; color: #667eea; border-radius: 8px; cursor: pointer; text-align: center; font-weight: 500; transition: all 0.3s; }
        .bot-option:hover { background: #667eea; color: white; }
        .status { padding: 12px; background: #e8f5e9; color: #2e7d32; border-radius: 8px; margin-bottom: 15px; text-align: center; font-weight: 500; }
        .status.info { background: #e3f2fd; color: #1976d2; }
        .status.warning { background: #fff3e0; color: #f57c00; }
        .link { color: #667eea; cursor: pointer; text-decoration: underline; }
        .typing-indicator { padding: 10px; text-align: left; }
        .typing-indicator span { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #999; margin: 0 2px; animation: typing 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-10px); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸš— Auto CRM</h1>
            <p>Your Perfect Car Awaits</p>
        </div>
        
        <div class="content">
            <!-- Login/Register Screen -->
            <div id="authScreen" class="screen active">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="customerName" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="customerEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="customerPassword" placeholder="Enter password" value="password">
                </div>
                <button class="btn btn-primary" onclick="register()">Register & Start</button>
                <button class="btn btn-secondary" onclick="loginExisting()">Login with Existing Account</button>
            </div>

            <!-- Chatbot Screen -->
            <div id="chatbotScreen" class="screen">
                <div class="status info">Hi! I'm your car advisor. Let me help you find your perfect car!</div>
                <div class="chat-box">
                    <div class="chat-messages" id="botMessages"></div>
                </div>
            </div>

            <!-- Sales Chat Screen -->
            <div id="salesChatScreen" class="screen">
                <div class="status" id="salesStatus">Connected with Sales Executive</div>
                <div class="chat-box">
                    <div class="chat-messages" id="salesMessages"></div>
                    <div class="chat-input-area">
                        <input type="text" id="salesMessageInput" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendSalesMessage()">
                        <button onclick="sendSalesMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let token = '';
        let customerId = null;
        let dealId = '';
        let stompClient = null;
        let currentQuestion = 0;
        let answers = {
            interestCategory: '',
            budgetRange: '',
            intendedTimeframe: '',
            preferredContactMode: 'phone'
        };

        const questions = [
            { text: "What type of car are you interested in?", options: ["SUV", "Sedan", "Hatchback", "Electric"], field: "interestCategory" },
            { text: "What's your budget range?", options: ["5-10 lakhs", "10-15 lakhs", "15-20 lakhs", "20+ lakhs"], field: "budgetRange" },
            { text: "When are you planning to buy?", options: ["1-2 months", "2-3 months", "3-6 months", "6+ months"], field: "intendedTimeframe" }
        ];

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function addBotMessage(text, showOptions = false) {
            const messagesDiv = document.getElementById('botMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.innerHTML = `
                <div class="message-sender">Bot Assistant</div>
                <div class="message-bubble">${text}</div>
            `;
            messagesDiv.appendChild(messageDiv);

            if (showOptions && currentQuestion < questions.length) {
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'bot-options';
                questions[currentQuestion].options.forEach(option => {
                    const btn = document.createElement('div');
                    btn.className = 'bot-option';
                    btn.textContent = option;
                    btn.onclick = () => selectOption(option);
                    optionsDiv.appendChild(btn);
                });
                messagesDiv.appendChild(optionsDiv);
            }

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addCustomerMessage(text) {
            const messagesDiv = document.getElementById('botMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message customer';
            messageDiv.innerHTML = `
                <div class="message-sender">You</div>
                <div class="message-bubble">${text}</div>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function selectOption(option) {
            addCustomerMessage(option);
            answers[questions[currentQuestion].field] = option;
            currentQuestion++;

            if (currentQuestion < questions.length) {
                setTimeout(() => {
                    addBotMessage(questions[currentQuestion].text, true);
                }, 500);
            } else {
                setTimeout(() => {
                    addBotMessage("Perfect! Let me find the best sales executive for you...");
                    createDeal();
                }, 500);
            }
        }

        function register() {
            const name = document.getElementById('customerName').value;
            const email = document.getElementById('customerEmail').value;
            const password = document.getElementById('customerPassword').value;

            if (!name || !email || !password) {
                alert('Please fill all fields!');
                return;
            }

            const timestamp = Date.now();
            const uniqueEmail = email.includes('@') ? email : `${email.replace(/[^a-z0-9]/gi, '')}${timestamp}@example.com`;

            console.log('Registering with:', uniqueEmail);

            fetch('http://localhost:8080/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    email: uniqueEmail,
                    password: password,
                    phone: `9999${timestamp.toString().slice(-6)}`,
                    address: 'Mumbai, India'
                })
            })
            .then(response => {
                console.log('Registration response status:', response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Registration failed: ${response.status} - ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (!data.token || !data.id) {
                    throw new Error('Invalid response from server');
                }
                token = data.token;
                customerId = data.id;
                console.log('Registered! Customer ID:', customerId, 'Token:', token.substring(0, 20) + '...');
                startChatbot();
            })
            .catch(error => {
                console.error('Registration error:', error);
                alert('Registration failed: ' + error.message);
            });
        }

        function loginExisting() {
            const email = document.getElementById('customerEmail').value;
            const password = document.getElementById('customerPassword').value;

            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }

            console.log('Attempting login with:', email);

            fetch('http://localhost:8080/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            })
            .then(response => {
                console.log('Login response status:', response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Login failed: ${response.status} - ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (!data.token || !data.id) {
                    throw new Error('Invalid login response');
                }
                token = data.token;
                customerId = data.id;
                console.log('Logged in! Customer ID:', customerId, 'Token:', token.substring(0, 20) + '...');
                startChatbot();
            })
            .catch(error => {
                console.error('Login error:', error);
                alert('Login failed! ' + error.message + '\n\nTry registering a new account instead.');
            });
        }

        function startChatbot() {
            showScreen('chatbotScreen');
            addBotMessage("Welcome! I'm here to help you find your dream car. ðŸš—");
            setTimeout(() => {
                addBotMessage(questions[0].text, true);
            }, 1000);
        }

        function createDeal() {
            if (!customerId || !token) {
                console.error('Missing customerId or token!', {customerId, token: token ? 'present' : 'missing'});
                addBotMessage("Authentication error. Please refresh and try again.");
                return;
            }

            const body = {
                customerId: customerId,
                interestCategory: answers.interestCategory,
                budgetRange: answers.budgetRange,
                intendedTimeframe: answers.intendedTimeframe,
                preferredContactMode: answers.preferredContactMode
            };

            console.log('Creating deal with:', body);
            console.log('Token:', token.substring(0, 30) + '...');
            console.log('Customer ID:', customerId);

            fetch('http://localhost:8080/api/deals/initiate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(body),
                mode: 'cors',
                credentials: 'omit'
            })
            .then(response => {
                console.log('Deal response status:', response.status);
                console.log('Deal response headers:', response.headers);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('API Error Response:', text);
                        throw new Error(`API Error: ${response.status} - ${text || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                dealId = data.id;
                console.log('Deal created successfully:', dealId);
                checkForSalesExecutive();
            })
            .catch(error => {
                console.error('Deal creation failed:', error);
                addBotMessage("Sorry, couldn't create deal. Error: " + error.message);
                addBotMessage("Please check browser console (F12) for details.");
            });
        }

        function checkForSalesExecutive() {
            fetch('http://localhost:8080/api/deals/' + dealId, {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(response => response.json())
            .then(data => {
                if (data.salesExecutiveId) {
                    addBotMessage(`Great news! I've connected you with ${data.salesExecutiveName} from ${data.dealerName}. They'll help you further! ðŸŽ‰`);
                    setTimeout(() => {
                        startSalesChat(data);
                    }, 2000);
                } else {
                    setTimeout(checkForSalesExecutive, 2000);
                }
            });
        }

        function startSalesChat(dealData) {
            showScreen('salesChatScreen');
            document.getElementById('salesStatus').innerHTML = 
                `<strong>${dealData.salesExecutiveName}</strong> from ${dealData.dealerName} | Status: ${dealData.status}`;
            
            connectWebSocket();
            
            // Load existing messages
            loadChatHistory();
        }

        function loadChatHistory() {
            fetch('http://localhost:8080/api/chats/deal/' + dealId + '/sales', {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(response => response.json())
            .then(chat => {
                if (chat.messages && chat.messages.length > 0) {
                    chat.messages.forEach(msg => {
                        displaySalesMessage(msg);
                    });
                }
            })
            .catch(error => console.log('No chat history yet'));
        }

        function connectWebSocket() {
            const socket = new SockJS('http://localhost:8080/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('WebSocket Connected');
                
                stompClient.subscribe('/topic/chat/' + dealId, function(message) {
                    const msg = JSON.parse(message.body);
                    displaySalesMessage(msg);
                });
            });
        }

        function displaySalesMessage(msg) {
            const messagesDiv = document.getElementById('salesMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (msg.senderType === 'CUSTOMER' ? 'customer' : 'sales');
            messageDiv.innerHTML = `
                <div class="message-sender">${msg.senderName}</div>
                <div class="message-bubble">${msg.content}</div>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendSalesMessage() {
            const input = document.getElementById('salesMessageInput');
            const content = input.value.trim();
            
            if (!content) return;

            const message = {
                dealId: dealId,
                senderId: customerId,
                senderName: 'Customer',
                senderType: 'CUSTOMER',
                content: content
            };

            if (stompClient && stompClient.connected) {
                stompClient.send("/app/chat/" + dealId, {}, JSON.stringify(message));
                input.value = '';
            }
        }
    </script>
</body>
</html>
